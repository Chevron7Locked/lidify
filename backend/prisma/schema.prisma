generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Album {
  id               String                   @id
  rgMbid           String
  artistId         String
  title            String
  year             Int?
  coverUrl         String?
  primaryType      String
  label            String?
  genres           Json?
  lastSynced       DateTime                 @default(now())
  location         AlbumLocation            @default(LIBRARY)
  searchVector     Unsupported("tsvector")?
  displayTitle     String?
  displayYear      Int?
  hasUserOverrides Boolean                  @default(false)
  userCoverUrl     String?
  userGenres       Json?
  originalYear     Int?
}

model ApiKey {
  id        String   @id
  userId    String
  key       String
  name      String
  lastUsed  DateTime @default(now())
  createdAt DateTime @default(now())
}

model Artist {
  id                  String                   @id
  mbid                String
  name                String
  normalizedName      String                   @default("")
  summary             String?
  heroUrl             String?
  genres              Json?
  lastSynced          DateTime                 @default(now())
  lastEnriched        DateTime?
  enrichmentStatus    String                   @default("pending")
  searchVector        Unsupported("tsvector")?
  similarArtistsJson  Json?
  displayName         String?
  hasUserOverrides    Boolean                  @default(false)
  userGenres          Json?
  userHeroUrl         String?
  userSummary         String?
  countsLastUpdated   DateTime?
  discoveryAlbumCount Int                      @default(0)
  libraryAlbumCount   Int                      @default(0)
  totalTrackCount     Int                      @default(0)
}

model Audiobook {
  id             String                   @id
  title          String
  author         String?
  narrator       String?
  description    String?
  publishedYear  Int?
  publisher      String?
  series         String?
  seriesSequence String?
  duration       Float?
  numTracks      Int?
  numChapters    Int?
  size           BigInt?
  isbn           String?
  asin           String?
  language       String?
  genres         String[]
  tags           String[]
  localCoverPath String?
  coverUrl       String?
  audioUrl       String
  libraryId      String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime
  lastSyncedAt   DateTime                 @default(now())
  searchVector   Unsupported("tsvector")?
}

model AudiobookProgress {
  id               String   @id
  userId           String
  audiobookshelfId String
  title            String
  author           String?
  coverUrl         String?
  currentTime      Float    @default(0)
  duration         Float    @default(0)
  isFinished       Boolean  @default(false)
  lastPlayedAt     DateTime @default(now())
  updatedAt        DateTime
  createdAt        DateTime @default(now())
}

model CachedTrack {
  id             String   @id
  userId         String
  trackId        String
  localPath      String
  quality        String
  fileSizeMb     Float
  cachedAt       DateTime @default(now())
  lastAccessedAt DateTime @default(now())
}

model DeviceLinkCode {
  id         String    @id
  code       String
  userId     String
  expiresAt  DateTime
  usedAt     DateTime?
  deviceName String?
  apiKeyId   String?
  createdAt  DateTime  @default(now())
}

model DiscoverExclusion {
  id              String   @id
  userId          String
  albumMbid       String
  artistName      String?
  albumTitle      String?
  lastSuggestedAt DateTime @default(now())
  expiresAt       DateTime
}

model DiscoveryAlbum {
  id            String         @id
  userId        String
  rgMbid        String
  artistName    String
  artistMbid    String?
  albumTitle    String
  lidarrAlbumId Int?
  downloadedAt  DateTime?
  folderPath    String         @default("")
  weekStartDate DateTime
  weekEndDate   DateTime       @default(now())
  status        DiscoverStatus @default(ACTIVE)
  likedAt       DateTime?
  similarity    Float?
  tier          String?
}

model DiscoveryBatch {
  id              String    @id
  userId          String
  weekStart       DateTime
  targetSongCount Int
  status          String    @default("downloading")
  totalAlbums     Int       @default(0)
  completedAlbums Int       @default(0)
  failedAlbums    Int       @default(0)
  finalSongCount  Int       @default(0)
  logs            Json?
  errorMessage    String?
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  version         Int       @default(0)
}

model DiscoveryTrack {
  id               String    @id
  discoveryAlbumId String
  trackId          String?
  fileName         String
  filePath         String
  inPlaylistCount  Int       @default(0)
  userKept         Boolean   @default(false)
  lastPlayedAt     DateTime?
}

model DislikedEntity {
  id         String   @id
  userId     String
  entityType String
  entityId   String
  dislikedAt DateTime @default(now())
}

model DownloadJob {
  id               String    @id
  correlationId    String?
  userId           String
  subject          String
  type             String
  targetMbid       String
  status           String
  error            String?
  lidarrRef        String?
  lidarrAlbumId    Int?
  metadata         Json?
  attempts         Int       @default(0)
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  discoveryBatchId String?
  triedReleases    String[]  @default([])
  releaseIndex     Int       @default(0)
  artistMbid       String?
  cleared          Boolean   @default(false)
}

model EnrichmentFailure {
  id            String    @id
  entityType    String
  entityId      String
  entityName    String?
  errorMessage  String?
  errorCode     String?
  retryCount    Int       @default(0)
  maxRetries    Int       @default(3)
  firstFailedAt DateTime  @default(now())
  lastFailedAt  DateTime  @default(now())
  skipped       Boolean   @default(false)
  skippedAt     DateTime?
  resolved      Boolean   @default(false)
  resolvedAt    DateTime?
  metadata      Json?
}

model Genre {
  id   String @id
  name String
}

model HiddenPlaylist {
  id         String   @id
  userId     String
  playlistId String
  createdAt  DateTime @default(now())
}

model LikedTrack {
  userId  String
  trackId String
  likedAt DateTime @default(now())

  @@id([userId, trackId])
}

model ListeningState {
  id         String   @id
  userId     String
  kind       String
  entityId   String
  trackId    String?
  positionMs Int      @default(0)
  updatedAt  DateTime
}

model MoodBucket {
  id        String   @id
  trackId   String
  mood      String
  score     Float
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model Notification {
  id        String   @id
  userId    String
  type      String
  title     String
  message   String?
  metadata  Json?
  read      Boolean  @default(false)
  cleared   Boolean  @default(false)
  createdAt DateTime @default(now())
}

model OwnedAlbum {
  artistId String
  rgMbid   String
  source   String

  @@id([artistId, rgMbid])
}

model Play {
  id       String       @id
  userId   String
  trackId  String
  playedAt DateTime     @default(now())
  source   ListenSource @default(LIBRARY)
}

model PlaybackState {
  userId       String   @id
  playbackType String
  trackId      String?
  audiobookId  String?
  podcastId    String?
  queue        Json?
  currentIndex Int      @default(0)
  isShuffle    Boolean  @default(false)
  updatedAt    DateTime
  createdAt    DateTime @default(now())
}

model Playlist {
  id                 String   @id
  userId             String
  mixId              String?
  name               String
  isPublic           Boolean  @default(false)
  createdAt          DateTime @default(now())
  spotifyPlaylistId  String?
  spotifyPlaylistUrl String?
}

model PlaylistItem {
  id         String @id
  playlistId String
  trackId    String
  sort       Int
}

model PlaylistPendingTrack {
  id               String   @id
  playlistId       String
  spotifyArtist    String
  spotifyTitle     String
  spotifyAlbum     String
  albumMbid        String?
  artistMbid       String?
  deezerPreviewUrl String?
  sort             Int
  createdAt        DateTime @default(now())
}

model Podcast {
  id              String                   @id
  feedUrl         String
  title           String
  author          String?
  description     String?
  imageUrl        String?
  localCoverPath  String?
  itunesId        String?
  language        String?
  explicit        Boolean                  @default(false)
  episodeCount    Int                      @default(0)
  lastRefreshed   DateTime                 @default(now())
  refreshInterval Int                      @default(3600)
  autoRefresh     Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime
  searchVector    Unsupported("tsvector")?
}

model PodcastDownload {
  id             String   @id
  userId         String
  episodeId      String
  localPath      String
  fileSizeMb     Float
  downloadedAt   DateTime @default(now())
  lastAccessedAt DateTime @default(now())
}

model PodcastEpisode {
  id             String                   @id
  podcastId      String
  guid           String
  title          String
  description    String?
  audioUrl       String
  duration       Int                      @default(0)
  publishedAt    DateTime
  episodeNumber  Int?
  season         Int?
  imageUrl       String?
  localCoverPath String?
  fileSize       Int?
  mimeType       String?                  @default("audio/mpeg")
  createdAt      DateTime                 @default(now())
  searchVector   Unsupported("tsvector")?
}

model PodcastProgress {
  id           String   @id
  userId       String
  episodeId    String
  currentTime  Float    @default(0)
  duration     Float    @default(0)
  isFinished   Boolean  @default(false)
  lastPlayedAt DateTime @default(now())
  updatedAt    DateTime
  createdAt    DateTime @default(now())
}

model PodcastSubscription {
  userId       String
  podcastId    String
  subscribedAt DateTime @default(now())

  @@id([userId, podcastId])
}

model SimilarArtist {
  fromArtistId String
  toArtistId   String
  weight       Float  @default(1.0)

  @@id([fromArtistId, toArtistId])
}

model SpotifyImportJob {
  id                 String   @id
  userId             String
  spotifyPlaylistId  String
  playlistName       String
  status             String
  progress           Int      @default(0)
  albumsTotal        Int
  albumsCompleted    Int      @default(0)
  tracksTotal        Int
  tracksMatched      Int      @default(0)
  tracksDownloadable Int      @default(0)
  createdPlaylistId  String?
  error              String?
  pendingTracks      Json
  createdAt          DateTime @default(now())
  updatedAt          DateTime
}

model SystemSettings {
  id                          String   @id @default("default")
  lidarrEnabled               Boolean  @default(true)
  lidarrUrl                   String?  @default("http://localhost:8686")
  lidarrApiKey                String?
  openaiEnabled               Boolean  @default(false)
  openaiApiKey                String?
  openaiModel                 String?  @default("gpt-4")
  openaiBaseUrl               String?
  fanartEnabled               Boolean  @default(false)
  fanartApiKey                String?
  audiobookshelfEnabled       Boolean  @default(false)
  audiobookshelfUrl           String?  @default("http://localhost:13378")
  audiobookshelfApiKey        String?
  soulseekUsername            String?
  soulseekPassword            String?
  spotifyClientId             String?
  spotifyClientSecret         String?
  musicPath                   String?  @default("/music")
  downloadPath                String?  @default("/downloads")
  autoSync                    Boolean  @default(true)
  autoEnrichMetadata          Boolean  @default(true)
  maxConcurrentDownloads      Int      @default(3)
  downloadRetryAttempts       Int      @default(3)
  transcodeCacheMaxGb         Int      @default(10)
  downloadSource              String   @default("soulseek")
  primaryFailureFallback      String   @default("none")
  updatedAt                   DateTime
  createdAt                   DateTime @default(now())
  enrichmentConcurrency       Int      @default(1)
  lidarrWebhookSecret         String?
  audioAnalyzerWorkers        Int      @default(2)
  clapWorkers                 Int      @default(2)
  lastfmApiKey                String?
  soulseekConcurrentDownloads Int      @default(4)
  soulseekEnabled             Boolean?
  soulseekDownloadPath        String?
  lastfmApiSecret             String?
  lastfmUserKey               String?
  lastfmEnabled               Boolean?
}

model Track {
  id                          String                   @id
  albumId                     String
  title                       String
  trackNo                     Int
  duration                    Int
  mime                        String?
  searchVector                Unsupported("tsvector")?
  filePath                    String
  fileModified                DateTime
  fileSize                    Int
  bpm                         Float?
  beatsCount                  Int?
  key                         String?
  keyScale                    String?
  keyStrength                 Float?
  energy                      Float?
  loudness                    Float?
  dynamicRange                Float?
  danceability                Float?
  valence                     Float?
  arousal                     Float?
  instrumentalness            Float?
  acousticness                Float?
  speechiness                 Float?
  moodHappy                   Float?
  moodSad                     Float?
  moodRelaxed                 Float?
  moodAggressive              Float?
  moodParty                   Float?
  moodAcoustic                Float?
  moodElectronic              Float?
  danceabilityMl              Float?
  moodTags                    String[]
  essentiaGenres              String[]
  lastfmTags                  String[]
  analysisStatus              String                   @default("pending")
  analysisVersion             String?
  analysisMode                String?
  analyzedAt                  DateTime?
  analysisError               String?
  analysisRetryCount          Int                      @default(0)
  updatedAt                   DateTime
  displayTitle                String?
  displayTrackNo              Int?
  hasUserOverrides            Boolean                  @default(false)
  analysisStartedAt           DateTime?
  vibeAnalysisStatus          String?
  vibeAnalysisStartedAt       DateTime?
  vibeAnalysisError           String?
  vibeAnalysisRetryCount      Int                      @default(0)
  vibeAnalysisStatusUpdatedAt DateTime?
}

model TrackGenre {
  trackId String
  genreId String

  @@id([trackId, genreId])
}

model TranscodedFile {
  id             String   @id
  trackId        String
  quality        String
  cachePath      String
  cacheSize      Int
  sourceModified DateTime
  lastAccessed   DateTime @default(now())
  createdAt      DateTime @default(now())
}

model UnavailableAlbum {
  id              String   @id
  userId          String
  artistName      String
  albumTitle      String
  albumMbid       String
  artistMbid      String?
  similarity      Float
  tier            String
  weekStartDate   DateTime
  previewUrl      String?
  deezerTrackId   String?
  deezerAlbumId   String?
  attemptNumber   Int      @default(0)
  originalAlbumId String?
  createdAt       DateTime @default(now())
}

model User {
  id                     String   @id
  username               String
  passwordHash           String
  role                   String   @default("user")
  onboardingComplete     Boolean  @default(false)
  enrichmentSettings     Json?
  twoFactorEnabled       Boolean  @default(false)
  twoFactorSecret        String?
  twoFactorRecoveryCodes String?
  moodMixParams          Json?
  tokenVersion           Int      @default(0)
  createdAt              DateTime @default(now())
}

model UserDiscoverConfig {
  id               String    @id
  userId           String
  playlistSize     Int       @default(40)
  maxRetryAttempts Int       @default(3)
  exclusionMonths  Int       @default(6)
  downloadRatio    Float     @default(1.3)
  enabled          Boolean   @default(true)
  lastGeneratedAt  DateTime?
}

model UserMoodMix {
  id          String   @id
  userId      String
  mood        String
  trackIds    String[]
  coverUrls   String[]
  generatedAt DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model UserSettings {
  userId          String  @id
  playbackQuality String  @default("original")
  wifiOnly        Boolean @default(false)
  offlineEnabled  Boolean @default(false)
  maxCacheSizeMb  Int     @default(10240)
}

model WebhookEvent {
  id            String    @id
  eventId       String    @unique
  source        String
  eventType     String
  payload       Json
  processed     Boolean   @default(false)
  processedAt   DateTime?
  correlationId String?
  error         String?
  retryCount    Int       @default(0)
  createdAt     DateTime  @default(now())

  @@index([correlationId])
  @@index([createdAt])
  @@index([processed])
  @@index([source, eventType])
}

model podcast_recommendations {
  id            String   @id
  podcastId     String
  recommendedId String
  title         String
  author        String?
  description   String?
  coverUrl      String?
  episodeCount  Int      @default(0)
  feedUrl       String?
  itunesId      String?
  score         Float    @default(0)
  cachedAt      DateTime @default(now())
  expiresAt     DateTime
}

enum AlbumLocation {
  LIBRARY
  DISCOVER
}

enum DiscoverStatus {
  ACTIVE
  LIKED
  MOVED
  DELETED
}

enum ListenSource {
  LIBRARY
  DISCOVERY
  DISCOVERY_KEPT
}
